---
title: "Engineering_Testing"
output: html_document
date: "2024-10-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Introduction 

In this notebook, we are reverse engineering the story, 
[Millions in out-of-state donations help fuel high-profile Maryland Democratic governor candidates]
(https://cnsmaryland.org/2022/03/03/millions-in-out-of-state-donations-help-fuel-high-profile-maryland-democratic-governor-candidates/)

I am going to play with the data cleaning to see if i can do something more straightforward
and observe how many addresses are out of whack

## Load libraries

Loading required libraries for this analysis.

```{r echo=FALSE, message=FALSE}
library(tidyverse)
library(janitor)
library(lubridate)
library(dplyr)
```

## Load and Cleaning Data

In this section, describe the source of the data, write a basic data dictionary 
for data you are working with, and discuss any caveats or issues you discovered 
working with this data. 

Data is provided by Professor Derek Willis. Each dataset is composed of the 
donations information for each candidate. 
This data has one column with an entire address of each donor. 
To successfully reverse engineer we need to tease out the states into its own col.
```{r}

# Load required data
Moore <- read_csv("data/Moore_ContributionsList.csv")
Perez <- read_csv("data/Perez_ContributionsList.csv")
King <- read_csv("data/King_ContributionsList.csv")
Franchot <- read_csv("data/Franchot_ContributionsList.csv")

```
```{r}
table(Moore$state)
table(Perez$state)
table(King$state)
table(Franchot$state)
```
```{r}
# Path to data should be loaded from folder "data" i.e. read_csv("data/name_of_data.csv")

# Clean required data and prepare for analysis if needed. 

# This is so that we are able to organize donations by states, as detailed in the story.
# To do this, I am going to employ the following function.
?str_sub_all()
?str_detect
# all states are right before the zip code (-6 ch), and only have two letters (start at -8)
```


```{r}
Moore  <-  Moore |> 
  mutate(state = str_sub(`Contributor Address`, start = -8, end = -7))

table(Moore$state)
# 0 - 1 NORWAY
# 21 - 1 MD
# AE - 1 APO
# Al - 1 SP
# ap - 1 SINGAPORE
# be - 1 AUS
# D - 5 MD
# Du - 1 Dubai UAE
# g - 1  Hong Kong
# is- 1 Lisbon Portugal
# on - 1 UK
# tc - 1 UK

Moore |> 
  filter(
    state == " O" |
    state == "21" |
    state == "AE" |
    state == "Al" |
    state == "ap" |
    state == "be" |
    state == "D " |
    state == "Du" |
    state == "g " |
    state == "is" |
    state == "on" |
    state == "tc"
  ) |> 
  select(`Contributor Address`, state)

Moore <- Moore |> 
  mutate(state = case_when(
    state == " O" ~ "NOR",
    state == "D " ~ "MD",
    state == "21" ~ "MD",
    state == "SP" ~ "ES",
    state == "ap" ~ "SG",
    state == "be" ~ "AUS",
    state == "Du" ~ "UAE",
    state == "g " ~ "HK",
    state == "is" ~ "POR",
    state == "on" ~ "UK",
    state == "tc" ~ "UK",
    TRUE ~ state
  ))

table(Moore$state)
```


```{r}
Perez  <-  Perez |> 
 mutate(state = str_sub(`Contributor Address`, start = -8, end = -7))

table(Perez$state)

# 21 - 1
# AE - 1
# D - 7

Perez |> 
  filter(state == "21"|
         state == "D " |
        state == "AE") |>
  select(`Contributor Address`, state)

Perez <- Perez |> 
  mutate(state = case_when(
    state == "21" ~ "MD",
    state == "D " ~ "MD",
    state == "AE" ~ "AP",
    TRUE ~ state
  ))

table(Perez$state)

```


```{r}
King  <-  King |>  
 mutate(state = str_sub(`Contributor Address`, start = -8, end = -7)) 

table(King$state)
# D - 1 MD
# AP - 1 Military
# e - 2 Canada
# GU - 3 guam

King |> 
  filter(state == "D "|
         state == "e ")
King <- King |> 
  mutate(state = case_when(
    state == "e " ~ "CAN",
    state == "D " ~ "MD",
    TRUE ~ state
  ))

table(King$state)

```
```{r}
Franchot <-  Franchot |>  
 mutate(state = str_sub(`Contributor Address`, start = -8, end = -7)) 

table(Franchot$state)

# picking out the ones that did not come out right
Franchot |> 
  filter(state == "00"|
         state == "01" |
         state == "03" |
         state == "04" |
         state == "05" |
         state == "06" |
         state == "07" |
         state == "08" |
         state == "09" |
         state == "11" |
         state == "13" |
         state == "14" |
         state == "15" |
         state == "16" |
         state == "18" |
         state == "20" |
         state == "21" |
         state == "22" |
         state == "23" |
         state == "24" |
         state == "33" |
         state == "40" |
         state == "60" |
         state == "65" |
         state == "70" |
         state == "71" |
         state == "74" |
         state == "75" |
         state == "77" |
         state == "78" |
         state == "79" |
         state == "80" |
         state == "81" |
         state == "85" |
         state == "87" |
         state == "92" |
         state == "93" |
         state == "95" |
         state == "A " |
         state == "D " |
         state == "C " |
         state == "E " |
         state == "L " |
        state == "Y ") |> 
  select(`Contributor Address`, state)

# isolating ones that have more than 1 result to see if it is 1 or more distinct state addresses
Franchot |>  
  filter(state == "00"|
         state == "01" |
         state == "18" |
         state == "21" |
         state == "33" |
         state == "70" |
         state == "93" |
         state == "95" |
         state == "A " |
         state == "D " |
         state == "C " |
         state == "E " |
         state == "L " |
        state == "Y ") |> 
  select(`Contributor Address`, state) |> 
  arrange(desc(state))

Franch_odds <- Franchot |>  # the duplicates that have multiple states
  filter(state == "00"|
         state == "01" |
         state == "21" |
         state == "70" |
         state == "A ") |> 
  select(`Contributor Address`, state) |> 
  arrange(desc(state))

Franchot <- Franchot |> 
  mutate(state = str_sub(`Contributor Address`, start = -8, end = -7)) |> 
  # first doing the str_sub for the ones that have uniform address zip format
  mutate(state = case_when( 
    # cleaning the ones that didnt format right because of different address format
    state == "00" ~ "MD", # also DC
    state == "01" ~ "MD", # also VA
    state == "03" ~ "MD",
    state == "04" ~ "MD",
    state == "05" ~ "MD",
    state == "06" ~ "MD",
    state == "07" ~ "MD",
    state == "08" ~ "MD",
    state == "09" ~ "MD",
    state == "11" ~ "MD",
    state == "13" ~ "MD",
    state == "14" ~ "MD",
    state == "15" ~ "MD",
    state == "16" ~ "MD",
    state == "18" ~ "VA",
    state == "20" ~ "MD",
    state == "21" ~ "MD", # and FL
    state == "22" ~ "MD",
    state == "23" ~ "MD",
    state == "24" ~ "MD",
    state == "33" ~ "PA",
    state == "40" ~ "MD",
    state == "60" ~ "MD",
    state == "65" ~ "MD",
    state == "70" ~ "MD", # also NJ
    state == "71" ~ "MD",
    state == "74" ~ "MD",
    state == "75" ~ "MD",
    state == "77" ~ "MD",
    state == "78" ~ "MD",
    state == "79" ~ "MD",
    state == "80" ~ "MD",
    state == "81" ~ "MD",
    state == "85" ~ "MD",
    state == "87" ~ "MD",
    state == "92" ~ "MD",
    state == "93" ~ "WY",
    state == "95" ~ "FL",
    state == "A " ~ "VA", # also PA, MA, VA
    state == "D " ~ "MD",
    state == "C " ~ "DC",
    state == "E " ~ "DE",
    state == "L " ~ "FL",
    state == "Y " ~ "NY",
    TRUE ~ state)) |>
  mutate(state = case_when(
    # finally, assigning the correct states to the leftovers that had duplicates 
    # from the original state assignment method with str_sub
    `Contributor Address` == "1735 Market Street  51st Floor  Philadelphia  PA 19103-" ~ "PA",
    `Contributor Address` == "1950 Old Gallows Road #600  Vienna  VA 22182-" ~ "VA",
    `Contributor Address` == "30 Main Street  Yarmouth Port  MA 02675-" ~ "MA",
    `Contributor Address` == "95 Oxford Avenue  Cambridge  MA 06671-" ~ "MA",
    `Contributor Address` == "15 America Ave.  Suite 302  Lakewood  NJ 08701-4594" ~ "NJ",
    `Contributor Address` == "4306 Lake Woodbourne Dr.  Jacksonville  FL 32217-4482" ~ "FL",
    `Contributor Address` == "5818 Robins Nest Ln.  Burke  VA 22015-3118" ~ "VA",
    `Contributor Address` == "733 - 15th St.  N.W.  Apt. 719  Washington  DC 20005-2163" ~ "DC",
    `Contributor Address` == "500 Eighth Street  NW  Washington  DC 20004-2131" ~ "DC",
    TRUE ~ state
  ))

# checking to see if most of the addresses changed to the correct state 

Franchot |> 
  filter(state == "PA" | state == "VA" | state == "MA" | state == "FL" | state == "NJ") |> 
    select(`Contributor Address`, state) |> 
  arrange(state)

table(Franchot$state) # all clean!
```


```{r}

states <- data.frame(
  state_abbrv = c(" AK"," AL"," APO"," AR"," AZ"," CA"," CO"," CT"," DC"," DE"," FL"," GA",
                     " GU"," HI"," IA"," ID"," IL"," IN"," KS"," KY"," LA"," MA"," MD",
                     " ME"," MI"," MN"," MO"," MS"," MT"," NC"," ND"," NE"," NH"," NJ"," NM",
                     " NV"," NY"," OH"," OK"," OR"," PA"," PR"," RI"," SC"," SD"," TN"," TX",
                     " UT"," VA"," VI"," VT"," WA"," WI"," WV"," WY", " YT CA"))
# 6 NON-STATES: AP(Armed Forces Pacific), PR(Puerto Rico), GU(Guam), VI(Virgin Islands), DC
# CANADA: YT CA
# the spaces here are very important, otherwise it will detect combinations of the
# letters from within the address names

for (state in states$state_abbrv) {
  Moore$state[str_detect(Moore$`Contributor Address`, state)] <- state
}

for (state in states$state_abbrv) {
  Perez$state[str_detect(Perez$`Contributor Address`, state)] <- state
}

for (state in states$state_abbrv) {
  King$state[str_detect(King$`Contributor Address`, state)] <- state
}

for (state in states$state_abbrv) {
  Franchot$state[str_detect(Franchot$`Contributor Address`, state)] <- state
}

# Now lets clean up that state var to be without the space
Moore  <-  Moore |> 
 mutate(state = str_sub(state, start = 2, end = 3))

King  <-  King |>  
 mutate(state = str_sub(state, start = 2, end = 3)) |> 
  mutate(state = case_when(
    state == "YT" ~ "CAN",
    TRUE ~ state))

Perez  <-  Perez |> 
 mutate(state = str_sub(state, start = 2, end = 3))

Franchot <-  Franchot |>  
 mutate(state = str_sub(state, start = 2, end = 3))

table(Moore$state)
table(Perez$state)
table(King$state)
table(Franchot$state)
```